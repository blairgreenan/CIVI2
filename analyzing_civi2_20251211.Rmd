---
title: "CIVI Indicators"
output: html_document
---

```{r, message=FALSE, error=FALSE, results='asis', warning=FALSE, echo=FALSE, comment=NA}
library(targets)
library(RColorBrewer)
library(dplyr)
library(leaflet)
library(htmltools)

civi <- read.csv("../CIVI.csv") # Need to fix this
indicators <- names(civi)[which(grepl("ind_", names(civi)))]
indicators <- indicators[which(grepl("Score", indicators))]

pal <- colorFactor(
  palette = rev(brewer.pal(5, "RdYlGn")),  # red=low, green=high
  domain = 1:5
)

map_list <- lapply(indicators, function(ind) {
  leaflet(civi) %>%
    addTiles() %>%
    addCircleMarkers(
      lng = ~Long,
      lat = ~Lat,
      color = ~pal(civi[[ind]]),
      radius = 6,
      stroke = FALSE,
      fillOpacity = 0.9,
      
      
      label = ~paste(
        "Harbour:", HarbourCode, "<br>",
        "NAME:", HarbourName, "<br>",
        ind, "score:", civi[[ind]]
      ) %>% lapply(htmltools::HTML)
      
      
      
      #label = ~paste(ind, "score:", civi[[ind]])
    ) %>%
    addLegend(
      "bottomright",
      pal = pal,
      values = 1:5,
      title = ind,
      opacity = 1
    )
})


# --- Build bins from quantiles and label them ---
civi_vals <- civi[["CIVI"]]
qs <- quantile(civi_vals, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE)

# Create an ordered factor: Low (green), Medium (yellow), High (red)
civi$CIVI_cat <- cut(
  civi_vals,
  breaks = qs,
  include.lowest = TRUE,
  labels = c("Low", "Medium", "High"),
  ordered_result = TRUE
)

# Ensure no leading/trailing whitespace and set as ordered factor
civi$CIVI_cat <- trimws(civi$CIVI_cat)
civi$CIVI_cat <- factor(
  as.character(civi$CIVI_cat),
  levels  = c("Low", "Medium", "High"),
  ordered = TRUE
)


# Re-create the palette NOW, using those levels
pal_civi3 <- colorFactor(
  palette  = c("#2ca02c", "#ffcb00", "#d62728"),  # Green, Yellow, Red
  domain   = c("Low", "Medium", "High"),          # explicit domain
  ordered = TRUE,
  na.color = "#777777"
)

indicators2 <- names(civi)[which(grepl("CIVI_cat", names(civi)))]


map_list2 <- lapply(indicators2, function(ind) {
  leaflet(civi) %>%
    addTiles() %>%
    addCircleMarkers(
      lng = ~Long,
      lat = ~Lat,
      fillColor = ~pal_civi3(CIVI_cat),
      radius = 6,
      stroke = FALSE,
      fillOpacity = 0.9,
      
      
      label = ~paste(
        "Harbour:", HarbourCode, "<br>",
        "NAME:", HarbourName, "<br>",
        ind, "score:", civi[[ind]]
      ) %>% lapply(htmltools::HTML)
      
      
      
      #label = ~paste(ind, "score:", civi[[ind]])
    ) %>%
    addLegend(
      "bottomright",
      pal    = pal_civi3,
      values = ~CIVI_cat,   # force legend order
      title  = "CIVI Category",
      opacity = 1
    )
})



map_list <- c(map_list, map_list2)

# Combine all maps into a tagList (for rendering in Shiny)
map_tags <- tagList(map_list)

# View in RStudio Viewer (if outside Shiny)
browsable(map_tags)



```
s
